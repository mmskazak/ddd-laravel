**ПРЕДМЕТНО-ОРИЕНТИРОВАННОЕ**
**ПРОЕКТИРОВАНИЕ С**
**LARAVEL**

**МАРТИН ДЖО**

Единственный подход к проектированию, который вам нужен

---

**Основные понятия**

    Domain-Driven Design
    Работа с данными
    Объекты-значения
    Объекты передачи данных
    Репозитории
    Пользовательские построители запросов
    Сервисы
    Действия
    ViewModels
    CQRS
    Состояния и переходы
    Домены и приложения
    Преимущества и недостатки

**Проектирование программного обеспечения для e-mail маркетинга**

    Обзор
        Подписчики
        Рассылки
        Последовательности
        Автоматизации
        Другие функции
        Почему e-mail маркетинг?
    Пользовательские истории
    Моделирование данных
        Подписчики
        Рассылки
        Отправленные письма
        Короткое замечание о производительности
        Последовательности
        Автоматизации
    Домены

**Создание программного обеспечения для e-mail маркетинга**

    Настройка доменов и приложений
    Подписчики
        Создание нового подписчика
        Обновление подписчика

Martin Joo — Предметно-ориентированное проектирование с Laravel

1 / 327


---

        View Models
        Vue Component
        Получение подписчиков
        Реальная мощь DTO и действий
        Заключение

    Рассылки
        DTO рассылки
        Обработка фильтров
        Upserting рассылки
        Фильтрация подписчиков
        Отправка рассылки
        Вычисление эффективности рассылки
        Предпросмотр рассылки
        Получение рассылок

    Последовательности
        Создание последовательности
        Продвижение последовательности
        Рефакторинг
        Обновление статуса подписчика
        Вычисление эффективности последовательности
        Прогресс последовательности

    Панель и отчеты
        Количество новых подписчиков
        Вся эффективность за все время
        Подписчики

    Автоматизации
        Upserting автоматизаций
        Запуск автоматизаций
    Заключение
    Спасибо

Martin Joo — Предметно-ориентированное проектирование с Laravel

2 / 327

---

# Основные понятия
## Предметно-ориентированное проектирование**

Прежде всего, мы должны ответить на самый очевидный вопрос: что такое предметно-ориентированное проектирование (Domain-Driven Design, DDD)?

DDD — это подход к разработке программного обеспечения, который пытается максимально сблизить бизнес-язык и код. Это наиболее важный атрибут этого подхода. Но по какой-то причине DDD — одна из самых неправильно понятых и чрезмерно усложнённых тем в сообществе разработчиков, поэтому я постараюсь объяснить её просто.

DDD учит нас двум основным вещам:

    **Стратегическое проектирование**
    **Техническое проектирование**

По моему честному мнению, стратегическое проектирование гораздо важнее технических аспектов. Трудно подытожить это одной крутой фразой, но ты увидишь, что я имею в виду, в оставшейся части книги. Пока что это основные столпы:

    * Домены и пространства имён. Позже я расскажу, что такое домен, но DDD учит нас структурировать код очень выразительно и логично.
    * Выбор правильных названий. Например, если в бизнесе пользователей называют «клиентами» или «сотрудниками», ты должен переименовать свой класс User, чтобы следовать этой конвенции.
    * Классы и объекты должны выражать заложенное в них намерение. В самом простом Laravel-приложении есть модели и контроллеры. Что ты думаешь, когда видишь проект с 50 моделями и 50 контроллерами? Ты видишь основную предметную область приложения, но тебе придётся копнуть глубже, если хочешь хорошо понимать функционал, верно? А как насчёт 300 моделей и 500 контроллеров? У тебя нет шансов осознать такое приложение.

В большинстве проектов разработчики предпочитают технические термины бизнес-концепциям. Это естественно. В конце концов, мы технические люди. Но у меня вопрос: действительно ли эти технические термины так важны?

Martin Joo — Предметно-ориентированное проектирование с Laravel

3 / 327

---

Позволь показать тебе пример. Это фрагмент из одного из моих приложений, которое я написал 28 октября 2016 года после того, как закончил книгу по шаблонам проектирования. Взгляни на него (это не Laravel):

```php
class Search_View_Container_Factory_Project
{
    /**
     * @var Search_View_Container_Relation_Project
     */
    private static $_relationContainer;

    /**
     * @param array $data
     * @return Search_View_Container_Project
     */
    public static function createContainer(array $data)
    {
        if ($data['current'] == 'complex') {
            return self::createComplex($data);
        } else {
            return self::createSimple($data);
        }
    }

    /**
     * @param array $data
     * @return Search_View_Container_Project
     */
    private static function createSimple(array $data)
    {
        $container = new Search_View_Container_Project('simple');
```

Martin Joo — Предметно-ориентированное проектирование с Laravel

4 / 327

---

```php
    $container->setSearchTerm(
        Arr::get($data, 'search_term')
    );

    $relationContainer = new 
        Search_View_Container_Relation_Project();

    $industryModel = new Model_Industry();
    $industries = $industryModel->getAll();

    foreach ($industries as $industry) {
        $industryItem = new Search_View_Container_Relation_Item(
            $industry, 
            Search_View_Container_Relation_Item::TYPE_INDUSTRY, 
            false
        );

        $relationContainer->addItem(
            $industryItem, 
            Search_View_Container_Relation_Item::TYPE_INDUSTRY
        );
    }

    $container->setRelationContainer($relationContainer);

    return $container;
```

Martin Joo — Предметно-ориентированное проектирование с Laravel

5 / 327

---


```php
    /**
     * @param array $models
     * @param int $type
     */
    private static function addItems(array $models, $type)
    {
        foreach ($models as $model) {
            $item = new Search_View_Container_Relation_Item(
                $model, 
                $type, 
                true
            );

            self::$_relationContainer->addItem($item, $type);
        }
    }
}
```

Сегодня 2 февраля 2022 года. Как думаешь, спустя шесть лет, понимаю ли я хоть что-то, что 
такое Search\_View\_Container\_Relation\_Item? Нет, я понятия не имею, что это. Я знаю только 
одно наверняка: это мне не помогает. Этот проект о фрилансерах и проектах. Этот класс делает 
что-то, связанное с поиском проектов (я предполагаю), но он не раскрывает это намерение. Ты 
когда-нибудь слышал, чтобы менеджер продукта говорил: «Вау, мы получили так много 
положительных отзывов о функции Search View Container Factory Project»?

Может быть, если я отступлю на шаг назад и посмотрю на структуру файлов, я что-то пойму лучше.

Martin Joo — Предметно-ориентированное проектирование с Laravel

6 / 327

---

И вот пример структуры файлов того старого проекта (именно та, что путает и не раскрывает сути):

```
classes git:(master) tree ./Search

./Search
├── Complex
│   └── Project.php
├── Factory
│   └── Project.php
├── Relation
│   └── Factory
│       └── Project.php
├── Simple
│   └── Project.php
└── View
    └── Container
        ├── Factory
        │   └── Project.php
        ├── Project.php
        └── Relation
            └── Project.php

9 directories, 7 files
```

Нет, всё равно понятия не имею. Вот моя мысль:

Технические термины и чрезмерно используемые шаблоны — отстой, когда речь идёт о высокоуровневых бизнес-приложениях.

Так что стратегическое проектирование — это всё о том, как **не** строить проекты вроде этого. А техническое проектирование даёт тебе некоторые полезные инструменты, чтобы этого добиться. На следующих страницах мы поговорим о следующих концепциях:

**Объекты-значения (Value Objects)**

---

**Объекты передачи данных (Data Transfer Objects)**
**Репозитории (Repositories)**
**Пользовательские построители запросов (Custom Query Builders)**
**Сервисы (Services)**
**Действия (Actions)**
**View Models (View Models)**
**CQRS (CQRS)**
**Состояния и переходы (States and Transitions)**
**Домены и приложения (Domains and Applications)**

Martin Joo — Предметно-ориентированное проектирование с Laravel

8 / 327

---

**Работа с данными**

Работа с данными — один из самых критически важных аспектов любого бизнес-приложения.
К сожалению, PHP не слишком хорош в этом плане. На мой взгляд, одна из лучших и худших особенностей PHP — это массивы. Особенно ассоциативные массивы. Проблемы такие:

* Нет type-hints (подсказок типов)
* Не задокументированная структура
* Нет ограничений. Ты можешь положить модели продуктов, ID продуктов и массивы продуктов под один и тот же ключ.

Ассоциативные массивы — это большие неструктурированные куски данных. Не пойми меня неправильно: они могут быть полезны, но в то же время очень раздражают. Изначально PHP-массивы пытались решить все задачи: очереди, стеки, списки, хеш-таблицы и деревья. Всё. Но с его слабой типизацией поддерживать такие структуры данных крайне тяжело.

Если подумать, данные играют огромную роль в любом бизнес-приложении:

* Приходит запрос. Он содержит входящие данные.
* Бизнес-слой обрабатывает эти данные.
* Слой базы данных вставляет эти данные в БД.
* Возвращается ответ. Он содержит исходящие данные.

Так что тебе придётся работать с данными на каждом уровне приложения. К счастью, Laravel и DDD дают нам несколько очень умных концепций.

Martin Joo — Предметно-ориентированное проектирование с Laravel

9 / 327

